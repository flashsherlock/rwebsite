---
title: 'ggplot2: Scales'
author: Fei
date: '2021-03-30'
slug: ggplot2-scales
categories:
  - R
tags:
  - plot
  - R
weight: 1
draft: yes
output:
  blogdown::html_page:
    toc: yes
    toc_depth: 3
    number_sections: yes
---

```{r include=FALSE}
knitr::opts_chunk$set(warning = F, message = F, cache = TRUE,tidy=F,fig.align='center',fig.showtext=TRUE,results="hold",fig.show = "hold")
library(tidyverse)
library(patchwork)
```

# Introduction
The scales toolbox divide scales into three main groups:

* Position scales and axes.
* Color scales and legends.
* Scales for other aesthetics.

# Position scales and axes
Sometimes an aesthetic is mapped to a **computed variable** that does not need to be explicitly specified, as happens with `geom_histogram()`, which use the computed variable `count`.

```{r eval=FALSE, include=FALSE}
ggplot(mpg, aes(x = displ)) + geom_histogram()
ggplot(mpg, aes(x = displ, y = after_stat(count))) + geom_histogram()
```

## Numeric
The most common continuous position scales are the default `scale_x_continuous()` and `scale_y_continuous()`. Other functions like `scale_x_log10()`, `scale_x_reverse()` transform the data, which can also be achieved by setting the `trans` option.

| Name      | Function $f(x)$         | Name      | Function $f(x)$         
|-----------|-------------------------|-----------|------------------------
| asn       | $\tanh^{-1}(x)$         | logit     | $\log(\frac{x}{1 - x})$ 
| exp       | $e ^ x$                 | pow10     | $10^x$                  
| identity  | $x$                     | probit    | $\Phi(x)$               
| log       | $\log(x)$               | reciprocal| $x^{-1}$                
| log10     | $\log_{10}(x)$          | reverse   | $-x$                    
| log2      | $\log_2(x)$             | sqrt      | $x^{1/2}$               

Specifically, if you use a transformed scale, the axes will be labeled in the original data space; if you transform the data, the axes will be labeled in the transformed space. To transform after statistical computation use `coord_trans()`.

```{r fig.height=2, fig.width=6}
# manual transformation
ggplot(mpg, aes(log10(displ), hwy)) + 
  geom_point() |

# transform using scales
ggplot(mpg, aes(displ, hwy)) + 
  geom_point() + 
  scale_x_log10()
```

By default, ggplot2 converts data outside the scale limits to `NA`, because the default value of `oob` (out of boundary) argument is `scales::censor()`. Setting it to `scales::squish()` will squishes all values into the range.

The space around the plot can be eliminated with `expand = c(0, 0)`. To make sure some values are shown on the plots, use `expand_limits()`.

```{r fig.height=2, fig.width=5}
ggplot(faithfuld, aes(waiting, eruptions)) + 
  geom_raster(aes(fill = density)) + 
  theme(legend.position = "none") +
  expand_limits(x=1,y=1)|

ggplot(faithfuld, aes(waiting, eruptions)) + 
  geom_raster(aes(fill = density)) + 
  scale_x_continuous(expand = c(0,0),trans = "reverse") + 
  scale_y_continuous(expand = c(0,0)) +
  theme(legend.position = "none")|
  
ggplot(faithfuld, aes(waiting, eruptions)) + 
  geom_raster(aes(fill = density)) +
  # multiply 5
  scale_x_continuous(expand = c(5,0)) + 
  # add 5 at each side
  scale_y_continuous(expand = c(0,5)) +
  theme(legend.position = "none")
```

Breaks can be added manually, but ggplot2 also allows you to pass a function to `breaks`:

* `scales::breaks_extended()`	creates automatic breaks for numeric axes (the standard method).
* `scales::breaks_log()`	creates breaks appropriate for log axes.
* `scales::breaks_pretty()`	creates "pretty" breaks for date/times.
* `scales::breaks_width()`	creates equally spaced 

Every break is associated with a label and these can be changed by setting the `labels` argument to the scale function:

* `scales::label_bytes()` formats numbers as kilobytes, megabytes etc.
* `scales::label_comma()` formats numbers as decimals with commas added.
* `scales::label_dollar()` formats numbers as currency.
* `scales::label_ordinal()` formats numbers in rank order: 1st, 2nd, 3rd etc.
* `scales::label_percent()` formats numbers as percentages.
* `scales::label_pvalue()` formats numbers as p-values: <.05, <.01, .34, etc.

As with breaks, you can also supply a function to minor_breaks, such as `scales::minor_breaks_n()` or `scales::minor_breaks_width()` functions that can be helpful in controlling the minor breaks. However, these minor breaks do not add ticks on the axis.

```{r fig.height=2, fig.width=9}
toy <- data.frame(
  const = 1,   up = 1:4,  txt = letters[1:4], 
  big = (1:4)*1000,  log = c(2, 5, 10, 2000))
# add breaks without labels
brks = seq(500, 4000, 250)
lbs <- ifelse(brks%%1000 == 0, brks, "")
# plot
axs <- ggplot(toy, aes(big, const)) + geom_point() + labs(x = NULL, y = NULL)
# minor breaks
axs + scale_x_continuous(breaks = scales::breaks_extended(n = 4),
                         minor_breaks = seq(1500,4000,250))|
# use offset to control breaks
axs + scale_x_continuous(breaks = scales::breaks_width(800, offset = 200))|
# control labels
axs + scale_y_continuous(labels = scales::label_dollar(prefix = "￥", suffix = "€"))|
# breaks without labels
axs + scale_x_continuous(breaks = brks, labels = lbs)
```

## Date-time
Different formats of date/time can be converted by a few functions (`as.Date()`, `as.POSIXct()` or `hms::as_hms()`) or the **lubridate** package. Default scale for dates is `scale_x_date()` and `scale_x_datetime()` is default for data-time data.

Breaks and minor breaks can be specified by `date_breaks` and `data_minor_breaks` respectively.  Date label formatting is useful when there's no sufficient room.

```{r fig.height=2, fig.width=6}
date_base <- ggplot(economics, aes(date, psavert)) + 
  geom_line(na.rm = TRUE) +
  labs(x = NULL, y = NULL)

date_base + scale_x_date(date_breaks = "25 years",
                         date_minor_breaks = "5 years",
                         date_labels = "%y") |
# formatting with function label_date, or label_date_short
date_base + scale_x_date(labels = scales::label_date("%Y"))
```

## Discrete
The default scales mapping discrete variables to position scales are `scale_x_discrete()` and `scale_y_discrete()`. Internally, ggplot2 handles discrete scales by mapping each category to an integer value and then drawing the geom at the corresponding coordinate location. Labels of the discrete variable can be set by `labels` and `guide_axis()` controls their layout.

```{r fig.height=2, fig.width=6}
base <- ggplot(mpg, aes(manufacturer, hwy)) + geom_boxplot()

base + guides(x = guide_axis(n.dodge = 3)) |
# as.character() is not needed for numbers
base + scale_x_discrete(labels = 1:length(unique(mpg$manufacturer)))+
       guides(x = guide_axis(angle = 90))
```

## Binned
Continuous variables can be sliced into multiple bins (e.g. `geom_count`).

```{r fig.height=2, fig.width=6}
base <- ggplot(mpg, aes(hwy, class)) + geom_count()

base |
base + scale_x_binned(n.breaks = 10)
```

## Limits
To make sure different plots share the same axes and legend, just like faceted plots, multiple limits (x, y, color, etc.) should be set.

```{r fig.height=2, fig.width=6}
mpg_99 <- mpg %>% filter(year == 1999)
mpg_08 <- mpg %>% filter(year == 2008)

base_99 <- ggplot(mpg_99, aes(displ, hwy, colour = fl)) + geom_point() 
base_08 <- ggplot(mpg_08, aes(displ, hwy, colour = fl)) + geom_point()

base_99 +
  scale_x_continuous(limits = c(1, 7)) +
  scale_y_continuous(limits = c(10, 45)) +
  scale_color_discrete(limits = c("c", "d", "e", "p", "r"))|
base_08 + 
  # lims() is another option
  lims(x = c(1, 7), y = c(10, 45), color = c("c", "d", "e", "p", "r"))
```

# Color scales and legends
## Continuous color scales
There are multiple ways to specify continuous color scales. There are many palettes available, but the common interface is **paletteer** package.

```{r fig.height=3, fig.width=4.6}
erupt <- ggplot(faithfuld, aes(waiting, eruptions, fill = density)) +
  geom_raster() +
  scale_x_continuous(NULL, expand = c(0, 0)) + 
  scale_y_continuous(NULL, expand = c(0, 0)) + 
  theme(legend.position = "none",
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        axis.line=element_blank(),)

plots <- list(erupt,
              erupt + scale_fill_viridis_c(option = "magma"),
              erupt + scale_fill_distiller(palette = "RdPu"),
              erupt + scico::scale_fill_scico(palette = "lajolla"),
              erupt + scale_fill_fermenter(),
              erupt + paletteer::scale_fill_paletteer_c("viridis::plasma"))
wrap_plots(plots,ncol = 3)
```

The default scale for continuous fill scales is `scale_fill_continuous()` which in turn defaults to `scale_fill_gradient()`. Gradient scales provide a robust method for creating any color scheme you like:

* `scale_fill_gradient()` produces a two-colour gradient
* `scale_fill_gradient2()` produces a three-colour gradient with specified midpoint
* `scale_fill_gradientn()` produces an n-colour gradient

Other packages, such as [**munsell**](https://github.com/cwickham/munsell/) and [**colorspace**](https://colorspace.r-forge.r-project.org/) also provide color palettes.

```{r fig.height=1.5, fig.width=4.6}
# munsell example
erupt + scale_fill_gradient(
  low = munsell::mnsl("5P 2/12"), 
  high = munsell::mnsl("5P 7/12")
) |
# colorspace examples
erupt + scale_fill_gradientn(colours = colorspace::heat_hcl(7))|
erupt + scale_fill_gradientn(colours = colorspace::diverge_hcl(7))
```

Missing values are set to grey by default, which can be changed by set `na.value` option. Breaks can be entirely suppressed by setting them to `NULL`.
```{r fig.height=1.5, fig.width=4.6}
df <- data.frame(x = 1, y = 1:5, z = c(1, 3, 2, NA, 5))
base <- ggplot(df, aes(x, y)) + 
  geom_tile(aes(fill = z), size = 5) + 
  labs(x = NULL, y = NULL)

base |
base + scale_fill_gradient(na.value = NA)|
base + scale_fill_gradient(na.value = "yellow",
                           breaks = NULL)+
        scale_x_continuous(breaks = NULL)
```

## Discrete colour scales
The default scale for discrete colors is `scale_fill_discrete()` which in turn defaults to `scale_fill_hue()`, and `scale_colour_brewer()` is a discrete color scale that—along with the continuous analog `scale_colour_distiller()` and binned analog `scale_colour_fermenter()` using handpicked [“ColorBrewer”](http://colorbrewer2.org/) colors.